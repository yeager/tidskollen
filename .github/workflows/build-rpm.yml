name: Build RPM

on:
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-rpm:
    runs-on: ubuntu-latest
    container: fedora:latest
    steps:
      - uses: actions/checkout@v4

      - name: Install tools
        run: dnf install -y rpm-build python3 gettext findutils tar gzip

      - name: Get version
        id: version
        run: |
          VER=$(python3 -c "import tomllib; print(tomllib.load(open('pyproject.toml','rb'))['project']['version'])")
          echo "version=$VER" >> $GITHUB_OUTPUT

      - name: Build RPM
        run: |
          PKG="tidskollen"
          VER="${{ steps.version.outputs.version }}"

          mkdir -p ~/rpmbuild/{SOURCES,SPECS}
          tar czf ~/rpmbuild/SOURCES/${PKG}-${VER}.tar.gz \
            --transform "s,^,${PKG}-${VER}/," \
            $(ls -d src/tidskollen tidskollen po data pyproject.toml *.desktop *.metainfo.xml 2>/dev/null)

          echo "TmFtZTogICAgICAgICAgIHRpZHNrb2xsZW4KVmVyc2lvbjogICAgICAgIFZFUlNJT05QTEFDRUhPTERFUgpSZWxlYXNlOiAgICAgICAgMQpTdW1tYXJ5OiAgICAgICAgVmlzdWFsIHNjaGVkdWxlIHRpbWVyIGZvciBjaGlsZHJlbiB3aXRoIGF1dGlzbQpMaWNlbnNlOiAgICAgICAgR1BMLTMuMApVUkw6ICAgICAgICAgICAgaHR0cHM6Ly9naXRodWIuY29tL3llYWdlci90aWRza29sbGVuClNvdXJjZTA6ICAgICAgICAle25hbWV9LSV7dmVyc2lvbn0udGFyLmd6CkJ1aWxkQXJjaDogICAgICBub2FyY2gKUmVxdWlyZXM6ICAgICAgIHB5dGhvbjMgPj0gMy45ClJlcXVpcmVzOiAgICAgICBndGs0ClJlcXVpcmVzOiAgICAgICBsaWJhZHdhaXRhCgolZGVzY3JpcHRpb24KVmlzdWFsIHNjaGVkdWxlIHRpbWVyIGZvciBjaGlsZHJlbiB3aXRoIGF1dGlzbQoKJXByZXAKJXNldHVwIC1xCgolaW5zdGFsbApQWU5BTUU9InRpZHNrb2xsZW4iCm1rZGlyIC1wICV7YnVpbGRyb290fS91c3IvbGliL3B5dGhvbjMvZGlzdC1wYWNrYWdlcy8kUFlOQU1FCmlmIFsgLWQgInNyYy8kUFlOQU1FIiBdOyB0aGVuCiAgY3AgLXIgc3JjLyRQWU5BTUUvKiAle2J1aWxkcm9vdH0vdXNyL2xpYi9weXRob24zL2Rpc3QtcGFja2FnZXMvJFBZTkFNRS8KZWxpZiBbIC1kICIkUFlOQU1FIiBdOyB0aGVuCiAgY3AgLXIgJFBZTkFNRS8qICV7YnVpbGRyb290fS91c3IvbGliL3B5dGhvbjMvZGlzdC1wYWNrYWdlcy8kUFlOQU1FLwpmaQoKbWtkaXIgLXAgJXtidWlsZHJvb3R9L3Vzci9iaW4KY2F0ID4gJXtidWlsZHJvb3R9L3Vzci9iaW4vJXtuYW1lfSA8PCAnTEFVTkNIRVInCiMhL3Vzci9iaW4vcHl0aG9uMwppbXBvcnQgc3lzCmZyb20gdGlkc2tvbGxlbi5tYWluIGltcG9ydCBtYWluCnN5cy5leGl0KG1haW4oKSkKTEFVTkNIRVIKY2htb2QgNzU1ICV7YnVpbGRyb290fS91c3IvYmluLyV7bmFtZX0KCm1rZGlyIC1wICV7YnVpbGRyb290fS91c3Ivc2hhcmUvYXBwbGljYXRpb25zCm1rZGlyIC1wICV7YnVpbGRyb290fS91c3Ivc2hhcmUvbWV0YWluZm8KbWtkaXIgLXAgJXtidWlsZHJvb3R9L3Vzci9zaGFyZS9pY29ucy9oaWNvbG9yL3NjYWxhYmxlL2FwcHMKZm9yIGYgaW4gZGF0YS8qLmRlc2t0b3AgKi5kZXNrdG9wOyBkbwogIFsgLWYgIiRmIiBdICYmIGluc3RhbGwgLW0gNjQ0ICIkZiIgJXtidWlsZHJvb3R9L3Vzci9zaGFyZS9hcHBsaWNhdGlvbnMvCmRvbmUKZm9yIGYgaW4gZGF0YS8qLm1ldGFpbmZvLnhtbCAqLm1ldGFpbmZvLnhtbDsgZG8KICBbIC1mICIkZiIgXSAmJiBpbnN0YWxsIC1tIDY0NCAiJGYiICV7YnVpbGRyb290fS91c3Ivc2hhcmUvbWV0YWluZm8vCmRvbmUKZmluZCBkYXRhL2ljb25zIC1uYW1lICIqLnN2ZyIgLXByaW50MCAyPi9kZXYvbnVsbCB8IHhhcmdzIC0wIC1Je30gaW5zdGFsbCAtbSA2NDQge30gJXtidWlsZHJvb3R9L3Vzci9zaGFyZS9pY29ucy9oaWNvbG9yL3NjYWxhYmxlL2FwcHMvIDI+L2Rldi9udWxsIHx8IHRydWUKCmZvciBwbyBpbiBwby8qLnBvOyBkbwogIFsgLWYgIiRwbyIgXSB8fCBjb250aW51ZQogIGxhbmc9JChiYXNlbmFtZSAiJHBvIiAucG8pCiAgbWtkaXIgLXAgJXtidWlsZHJvb3R9L3Vzci9zaGFyZS8le25hbWV9L2xvY2FsZS8kbGFuZy9MQ19NRVNTQUdFUwogIG1zZ2ZtdCAtbyAle2J1aWxkcm9vdH0vdXNyL3NoYXJlLyV7bmFtZX0vbG9jYWxlLyRsYW5nL0xDX01FU1NBR0VTLyV7bmFtZX0ubW8gIiRwbyIKZG9uZQoKJWZpbGVzCi91c3IvYmluLyV7bmFtZX0KL3Vzci9saWIvcHl0aG9uMy9kaXN0LXBhY2thZ2VzL3RpZHNrb2xsZW4vCi91c3Ivc2hhcmUvYXBwbGljYXRpb25zLwovdXNyL3NoYXJlL21ldGFpbmZvLwovdXNyL3NoYXJlL2ljb25zLwovdXNyL3NoYXJlLyV7bmFtZX0vCg==" | base64 -d | sed "s/VERSIONPLACEHOLDER/$VER/" > ~/rpmbuild/SPECS/${PKG}.spec

          rpmbuild -bb ~/rpmbuild/SPECS/${PKG}.spec
          cp ~/rpmbuild/RPMS/noarch/*.rpm .

      - name: Upload RPM to release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VER="${{ steps.version.outputs.version }}"
          RPM=$(ls *.rpm | head -1)
          gh release upload "v${VER}" "$RPM" --clobber 2>/dev/null || \
          gh release upload "${{ github.ref_name }}" "$RPM" --clobber 2>/dev/null || true
